# Quantizing Face Detection using SeeDot

Face Detection using SeeDot can be performed on the `face-2` and `face-4` datasets, which are processed subsets of the [SCUT Heads](https://github.com/HCIILAB/SCUT-HEAD-Dataset-Release) dataset.

Face Detection is a regression problem that involves an image input with (or without) faces and bounding boxes around the faces as output. 
Face Detection is supported for x86 and M3 target devices.  

### Obtaining the datasets
To obtain the model weights and datasets for the face detection problem, run `fetchFDDataset.py` in `seedot/compiler/input/` folder.
Or simply run the commands from SeeDot's home directory (`EdgeML/tools/SeeDot/`):
```
    cd seedot/compiler/input/
    python fetchFDDataset.py
```

This python script will place the model weights in `model/rnnpool/face-2/` for the `face-2` dataset and in `model/rnnpool/face-2/` for the `face-4` dataset.
The datasets are placed in `datasets/rnnpool/face-2/` for the `face-2` dataset and in `datasets/rnnpool/face-2/` for the `face-4` dataset.

### Run Face Detection for x86
To run face detection using the SeeDot quantizer for x86 devices, run the command: 

```
    python SeeDot-dev.py -a rnnpool -e fixed -m disagree -d face-2 -dt testing -t x86 -n 18000 
```
for the `face-2` dataset, and:
```
    python SeeDot-dev.py -a rnnpool -e fixed -m disagree -d face-4 -dt testing -t x86 -n 18000 
```
for the `face-4` dataset.

The non-optional arguments used in the above commands are:
```
    Argument            Value       Description
    
    -a, --algo          rnnpool     Face detection problem uses the 'rnnpool' machine learning
                                    algorithm.

    -e, --encoding      fixed/      The encoding to use for face detection. 
                        float       The options are 'float' and 'fixed'.

    -m, --metric        disagree    The metric used to measure correctness of prediction.
                                    This is used for quantization. 

    -d, --dataset       face-2/     The dataset to use for face detection. 
                        face-4      The options are 'face-2' and 'face-4'.
    
    -dt, --datesetType  training/   The type of the dataset to use for quantization. 
                        testing     The options are 'training' and 'testing'.
                                    Default is 'testing'.

    -t, --target        x86         The target device for which the code has to be generated. 
                                    'x86' in this case.

    -n, --numOutputs    18000       The size of the output vector of rnnpool face detection
                                    algorithm.
                      
```
The output will be stored in the `temp/` directory by default. Use the `-o <destination folder>` flag to store the output to an already existing location. 

### Run Face Detection for M3
To run face detection using the SeeDot quantizer for M3 device, run the command: 

```
    python SeeDot-dev.py -a rnnpool -e fixed -m disagree -d face-2 -dt testing -t m3 -n 18000 
```
for the `face-2` dataset, and:
```
    python SeeDot-dev.py -a rnnpool -e fixed -m disagree -d face-4 -dt testing -t m3 -n 18000 
```
for the `face-4` dataset.

Note: The target device specified using `-t` argument has the value `m3` in this case. See above for detailed argument description.

The output will be stored to the `m3dump/` directory by default. Use the `-o <destination folder>` flag to store the output to an already existing location. 

## Run SeeDot's output quantized code
This section discusses the execution of the quantized fixed-point model generated by SeeDot.
The quantized `x86` codes are stored in the `temp/` directory by default. 

To run the model, navigate to `temp/Predictor` and run the `Predictor` executable as shown below:

```
    cd temp/Predictor
    ./Predictor fixed testing regression 18000
```

Here, specifying all arguments is necessary. The arguments' description:
```
    Argument        Description

    fixed           The encoding. This is dependent on the 'encoding' argument 
                    given to SeeDot. 
    
    testing         This is the argument in SeeDot specified by 'datasetType' field.
    
    regression      This is the type of problem ('classification' and 'regression'). 
                    This argument is inferred by SeeDot automatically.
    
    18000           This is equal to the argument specified in SeeDot's execution using
                    the 'numOutputs' field.
```
This code takes its input from the `input` directory in `temp/Predictor`.
This input directory consists of two CSV files, `X.csv`, which contains the floating-point input values; and `Y.csv`, which consists of the correct integer labels (floating-point outputs) in case of classification (regression).

Each row of `X.csv` corresponds to one set of input variables and, each row of `Y.csv`
corresponds to the respective label/outputs. 

For example, in the case of `face-2` and `face-4`, the input layer size is *76800* and the output 
has *18000* values. 
So, each row of `X.csv` will have *76800* elements and, each row of `Y.csv` will have *18000*
elements. Trivially, both `X.csv` and `Y.csv` will have an equal number of rows. 

Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.

